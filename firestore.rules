rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user ID
    function getUserId() {
      return request.auth.uid;
    }
    
    // Helper function to validate player data structure
    function isValidPlayerData() {
      return request.resource.data.keys().hasAll(['value']) &&
             request.resource.data.value is map;
    }
    
    // Helper function to validate chat message
    function isValidChatMessage() {
      return request.resource.data.keys().hasAll(['value']) &&
             request.resource.data.value is list &&
             (request.resource.data.value.size() == 0 || 
              (request.resource.data.value[-1].playerId == getUserId()));
    }
    
    // Helper function to validate inbox entry
    function isValidInboxEntry() {
      return request.resource.data.keys().hasAll(['value']) &&
             request.resource.data.value is list;
    }
    
    // Helper function to validate market listing
    function isValidMarketListing() {
      return request.resource.data.keys().hasAll(['value']) &&
             request.resource.data.value is list;
    }
    
    // Helper function to validate leaderboard entry
    function isValidLeaderboardData() {
      return request.resource.data.keys().hasAll(['value']) &&
             request.resource.data.value is map;
    }
    
    // ========================================
    // PLAYER DATA (Private - User Specific)
    // ========================================
    match /players/{playerId} {
      // Allow read/write only to the owner
      match /{document=**} {
        allow read, write: if isAuthenticated() && playerId == getUserId();
      }
    }
    
    // ========================================
    // SHARED DATA (Public with Restrictions)
    // ========================================
    match /shared_data/{docId} {

      // --- CHAT MESSAGES (Subcollection Architecture) ---
      match /chat-messages/{messageId} {
        allow read: if true;

        allow create: if isAuthenticated() &&
                      request.resource.data.playerId == getUserId() &&
                      request.resource.data.playerName is string &&
                      request.resource.data.message is string &&
                      request.resource.data.timestamp is number &&
                      request.resource.data.channel is string;

        // Prevent updates, allow delete for cleanup (old messages)
        allow update: if false;
        allow delete: if isAuthenticated();
      }

      // Legacy chat-messages document (for backward compatibility during migration)
      allow read: if docId == 'chat-messages';
      allow write: if false; // Prevent writes to legacy document
      
      // --- PLAYER INBOX ---
      allow read: if isAuthenticated() && 
                  docId == 'player-inbox';
      
      allow write: if isAuthenticated() && 
                   docId == 'player-inbox' &&
                   isValidInboxEntry();
      
      // --- MARKET LISTINGS ---
      // Anyone can read active listings
      allow read: if true;
      
      // Market listings - authenticated users can write
      // Note: .all() lambda is not supported in Firestore rules.
      // Server-side validation via Cloud Functions is recommended
      // for verifying individual listing ownership.
      allow write: if isAuthenticated() &&
                   docId == 'market-listings' &&
                   isValidMarketListing();
      
      // --- LEADERBOARD ---
      allow read: if true;
      
      allow write: if isAuthenticated() &&
                   docId == 'leaderboard-data' &&
                   isValidLeaderboardData();
      
      // --- TRADES ---
      allow read: if isAuthenticated() && 
                  (docId.startsWith('trades_') && 
                   (resource.data.value.senderId == getUserId() || 
                    resource.data.value.targetId == getUserId() ||
                    request.resource.data.value.senderId == getUserId() ||
                    request.resource.data.value.targetId == getUserId()));
      
      allow write: if isAuthenticated() && 
                   docId.startsWith('trades_') &&
                   (request.resource.data.value.senderId == getUserId() ||
                    request.resource.data.value.targetId == getUserId());
      
      // --- PUBLIC PROFILES ---
      allow read: if true;
      
      allow write: if isAuthenticated() && 
                   docId.startsWith('public-profile:') &&
                   request.resource.data.value.playerId == getUserId();
      
      // --- DEFAULT: Deny all other shared documents ---
      match /{otherDoc} {
        allow read, write: if false;
      }
    }
    
    // ========================================
    // DATA VALIDATION HELPERS
    // ========================================
    
    function isNonNegativeNumber(val) {
      return val is number && val >= 0;
    }
    
    function isPositiveInteger(val) {
      return val is number && val == val.floor() && val > 0;
    }
    
    function isValidString(str, minLen, maxLen) {
      return str is string && 
             str.size() >= minLen && 
             str.size() <= maxLen;
    }
  }
}
